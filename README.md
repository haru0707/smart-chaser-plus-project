# Smart Chaser+

U-16プログラミングコンテスト北海道大会向けのCHaserボットプログラム。

## CHaserとは

CHaser（チェイサー）は、2体のボットが格子状のマップ上で対戦するプログラミング競技です。プレイヤーは自分のボットをプログラムで制御し、アイテムを収集したり、相手を妨害したりして勝利を目指します。

### ルール概要（北海道大会 v3.0.1）

| 項目 | 内容 |
|:---|:---|
| マップサイズ | 15×17マス（点対称配置） |
| ターン数 | 100〜240ターン（ランダム） |
| 視野 | 周囲3×3マス + Search（直線9マス） |

### 勝利条件

| 優先度 | 条件 | 説明 |
|:---:|:---|:---|
| 1 | 即時勝利 | 敵の上にブロックを置く |
| 2 | 包囲勝利 | 敵の4方向をブロックで囲む |
| 3 | 得点勝利 | ターン終了時にアイテム数で上回る |

### 基本アクション

| コマンド | 説明 |
|:---|:---|
| Walk | 上下左右に1マス移動（アイテム取得可能） |
| Put | 上下左右にブロック設置 |
| Look | 上下左右方向の3×3マスを確認 |
| Search | 上下左右方向の直線9マスを確認 |

---

## 必要環境

- **Ruby** 3.0以上推奨（2.7でも動作）
- **libui** gem（GUIデバッグ機能使用時のみ）

### インストール

```bash
# GUIデバッグ機能を使用する場合
gem install libui

# GUIなしでも動作します（自動でフォールバック）
```

---

## 使い方

### 基本実行

```bash
ruby smart_chaser+.rb
```

実行後、以下を入力します：
1. サーバーのIPアドレス（例: `127.0.0.1`）
2. ポート番号（例: `2009` または `2010`）

### デバッグモード（GUI表示）

```bash
# Windows (PowerShell)
$env:SMART_CHASER_DEBUG=1; ruby smart_chaser+.rb

# Windows (コマンドプロンプト)
set SMART_CHASER_DEBUG=1 && ruby smart_chaser+.rb

# Linux/macOS
SMART_CHASER_DEBUG=1 ruby smart_chaser+.rb
```

---

## アルゴリズム詳細

### 1. A*経路探索

目標地点への最適経路を探索します。以下のコストを考慮：

```
総コスト = 移動コスト + 敵接近ペナルティ + 訪問ペナルティ + 方向転換ペナルティ
```

| コスト要素 | 説明 |
|:---|:---|
| 移動コスト | 基本1.0/マス |
| 敵接近ペナルティ | 敵との距離に応じて最大100.0 |
| 訪問ペナルティ | 訪問回数 × 0.5（同じ場所を避ける） |
| 方向転換ペナルティ | 0.3（直進を優先してジグザグを抑制） |

### 2. 敵位置予測（確率的ヒートマップ）

敵の位置を確率分布として追跡します：

- **初期推定**: 点対称マップの性質を利用して敵の初期位置を推定
- **確率拡散**: 敵が見えないターンは隣接マスに確率を拡散（減衰率0.95）
- **視界クリア**: 視界内に敵がいなければその領域の確率を0に

### 3. マップ位置特定（Map Localization）

相対座標から絶対座標を推定するシステム：

- 観測したブロック・アイテムの配置パターンからマップ上の絶対位置を特定
- 位置確定後は**対称推論**が有効化され、マップの反対側の情報も推測可能に

### 4. トラップ（袋小路）検知

アイテム取得時の危険を回避：

- **BFS連結性計算**: 進入後に到達可能なマス数をカウント
- **Searchキャッシュ**: 過去のSearch結果を再利用して無駄なSearchを削減
- **3手先の行き止まり**を自動検知してトラップをマーク

### 5. 動的戦略モード

ゲーム状況に応じて戦略を自動切り替え：

| モード | 発動条件 | 重み付け |
|:---|:---|:---|
| 探索重視 | 序盤（進行率25%以下） | 探索×2.0 |
| バランス | 中盤 | 全て×1.0 |
| アイテム集中 | 終盤（進行率75%以上） | アイテム×2.0 |
| 攻撃重視 | アイテム3個以上負け | 攻撃×2.0 |
| 守備重視 | アイテム4個以上勝ち | 逃走×2.0 |

**ヒステリシス機能**: 境界付近での頻繁な戦略切り替えを防止

### 6. アイテム収集最適化

効率的なアイテム収集を実現：

- **直線アイテム端優先**: 3個以上直線に並んでいる場合は端から取得
- **TSP的巡回計画**: ニアレストネイバー法で効率的なルートを計算
- **連結性スコア**: 袋小路のアイテムは優先度を下げる

---

## GUIデバッグ機能

libui gemがインストールされている場合、リアルタイムでゲーム状況を可視化できます。

### 表示要素

| 色 | 意味 |
|:---|:---|
| 青 | 自分の位置 |
| 赤 | 敵の位置 |
| 緑 | アイテム |
| グレー | ブロック |
| 紫 | トラップ（袋小路） |
| 黄 | 探索中（Search予定地点） |

### コントロール

| ボタン | 機能 |
|:---|:---|
| リアルタイム ON/OFF | 最新状態を自動追従 or 手動操作 |
| ヒートマップ ON/OFF | 敵の存在確率を色で表示 |
| 戻る/進む | 過去のターンを確認 |
| スライダー | 任意のターンにジャンプ |

### ヒートマップモード

敵の存在確率を視覚化：
- **青**: 低確率（0%付近）
- **赤**: 高確率（100%付近）

---

## ファイル構成

```
smart_chaser+_project/
├── smart_chaser+.rb          # エントリーポイント
├── CHaserConnect.rb          # サーバー通信（TCP/IP）
├── README.md
└── lib/
    ├── core.rb               # モジュール統合・GUI初期化
    └── smart_chaser/
        ├── constants.rb      # 定数・マップサイズ・タイル定義
        ├── gameplay.rb       # ゲームループ・意思決定ロジック
        ├── strategy.rb       # 移動方向選択・逃走・探索
        ├── pathfinding.rb    # A*探索・連結性計算・袋小路検知
        ├── enemy_tracker.rb  # 敵追跡・確率ヒートマップ
        ├── scoring.rb        # 得点計算・戦略モード・アイテム効率
        ├── attack_strategy.rb # 攻撃評価・包囲判定
        ├── map_symmetry.rb   # 点対称推論
        ├── map_localizer.rb  # 絶対位置特定
        ├── decision_logger.rb # 意思決定ログ（デバッグ用）
        ├── rendering.rb      # GUI描画（libui）
        └── utilities.rb      # 汎用ユーティリティ
```

---

## カスタマイズ

### マップサイズ変更

`lib/smart_chaser/constants.rb` を編集：

```ruby
# マップサイズ（大会ルールに合わせて変更）
MAP_WIDTH = 15
MAP_HEIGHT = 17

# ターン数範囲
MIN_TURNS = 100
MAX_TURNS = 240
```

### 戦略パラメータ調整

`lib/smart_chaser/scoring.rb` で戦略の重み付けを調整できます：

```ruby
def strategy_weights
  case @current_strategy
  when :defensive
    { escape: 2.0, attack: 0.5, item: 0.8, explore: 0.3 }
  when :aggressive
    { escape: 0.8, attack: 2.0, item: 0.5, explore: 0.3 }
  # ...
  end
end
```

### トラップ検知の調整

`lib/smart_chaser/constants.rb` で感度を調整：

```ruby
TRAP_SEARCH_DEAD_END_DISTANCE = 3  # 何手先まで行き止まりをチェックするか
TRAP_DEAD_END_THRESHOLD = 1        # 到達可能マス数がこれ以下ならトラップ
TRAP_REQUIRED_ESCAPE_OPTIONS = 1   # 必要な逃げ道の数
```

---

## トラブルシューティング

### 接続できない

```
"foolish_bot"はサーバに接続出来ませんでした
```

- CHaserサーバーが起動しているか確認
- IPアドレス・ポート番号が正しいか確認
- ファイアウォールの設定を確認

### GUIが表示されない

```ruby
# libui がインストールされていない場合は自動的にCUIモードで動作
gem install libui
```

### 文字化けする

なでしこサーバー（ポート40000/50000）使用時は自動的にCP932エンコードに変換されます。それ以外のサーバーではUTF-8が使用されます。

---

## 技術的特徴

- **完全自律型AI**: 人間の介入なしに意思決定
- **確率的推論**: 不完全情報下での敵位置予測
- **適応型戦略**: ゲーム状況に応じた動的な戦略変更
- **効率的探索**: メモ化・キャッシュによるパフォーマンス最適化
- **堅牢性**: タイムアウト回避・エラーハンドリング

---

## ライセンス

本プログラムは [GNU General Public License v3.0](https://www.gnu.org/licenses/gpl-3.0.html) の下で公開されています。

- 自由に使用、複製、改変、再配布が可能です
- 派生物も同じGPL v3ライセンスで公開する必要があります
- 詳細はLICENSEファイルを参照してください
